version: '2'

services:

  postgres_server:
    build: ./postgres
    volumes:
      - "/opt/teamcity/pg_data:/var/lib/postgresql/data"
      - "/opt/teamcity/pg_backup:/backups"
    env_file: .env
    restart: always

  server:
    image: jetbrains/teamcity-server:latest
    hostname: ${VIRTUAL_HOST}
    volumes:
      - "/opt/teamcity/data:/data/teamcity_server/datadir"
      - "/opt/teamcity/log:/opt/teamcity/logs"
    ports:
      - 8111:8111
    depends_on:
      - postgres_server
    env_file: .env
    restart: always

  agent:
    build: https://github.com/UsAndRufus/docker-teamcity-agent-rbenv.git
    environment:
      - AGENT_NAME=rbenv builder
      - DATABASE_URL=postgresql://prayermate:dev@postgres:5432/prayermate_test?encoding=UTF8&pool=5&timeout=5000
    volumes:
      - 'teamcity_agent_rbenv_conf:/data/teamcity_agent/conf'
      - '/opt/teamcity/platform/system:/data/teamcity_agent/platform/system'
    restart: always
    depends_on:
      - postgres_agent

  postgres_agent:
    image: postgres:9.6.13
    restart: always
    ports:
      - '5432:5432'
    environment:
      - POSTGRES_DB=prayermate
      - POSTGRES_USER=prayermate
      - POSTGRES_PASSWORD=dev
    volumes:
      - ./tmp/db:/var/lib/postgresql/data

#  nginx:
#    image: nginx
#    links:
#      - server
#    volumes:
#      - "./server/tc.conf:/etc/nginx/conf.d/default.conf"
#    env_file: .env
#
#  nginx-proxy:
#    image: jwilder/nginx-proxy
#    ports:
#      - "80:80"
#      - "443:443"
#    volumes:
#      - "./nginx/vhost.d:/etc/nginx/vhost.d"
#      - "./nginx/html:/usr/share/nginx/html"
#      - "./nginx/certs:/etc/nginx/certs"
#      - "/var/run/docker.sock:/tmp/docker.sock:ro"
#      - "./server/proxy.conf:/etc/nginx/conf.d/proxy.conf"
#
#  letsencrypt-nginx-proxy-companion:
#    image: jrcs/letsencrypt-nginx-proxy-companion
#    volumes:
#      - "/var/run/docker.sock:/var/run/docker.sock:ro"
#    volumes_from:
#      - "nginx-proxy"

volumes:
  teamcity_agent_rbenv_conf: